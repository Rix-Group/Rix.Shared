name: Deploy Rix.Mediator NuGet Package

on:
  push:
    branches:
      - main
    paths:
      - 'src/Rix.Mediator/**'
  workflow_dispatch:
    # Added to be able to trigger manually

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    env:
      PROJECT_PATH: 'src/Rix.Mediator/Rix.Mediator/Rix.Mediator.csproj'
      TEST_PROJECT_PATH: 'src/Rix.Mediator/Rix.Mediator.Tests/Rix.Mediator.Tests.csproj'

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            9.0.x
            10.0.x

      - name: ‚öôÔ∏è Restore Dependencies
        run: |
          dotnet restore ${{ env.PROJECT_PATH }}
          dotnet restore ${{ env.TEST_PROJECT_PATH }}

      - name: ‚úÖ Run Unit Tests
        run: |
          dotnet test ${{ env.TEST_PROJECT_PATH }} \
            --configuration Release \
            --no-restore \
            --framework net10.0

      - name: üì¶ Build and Pack NuGet
        id: pack
        run: |
          dotnet pack ${{ env.PROJECT_PATH }} \
            --configuration Release \
            /p:Version=1.0.${{ github.run_number }} \
            --output nupkg

      - name: ‚¨ÜÔ∏è Publish to GitHub Packages NuGet Feed
        run: |
          DOTNET_SOURCE=https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json
          PACKAGE_PATH=$(find ./nupkg -name "Rix.Mediator*.nupkg" | head -n 1)

          echo "Pushing package: ${PACKAGE_PATH} to ${DOTNET_SOURCE}"

          dotnet nuget push $PACKAGE_PATH \
            --source $DOTNET_SOURCE \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --skip-duplicate